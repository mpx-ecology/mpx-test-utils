<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>快速开始 | Mpx框架单元测试</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/mpx-test-utils/favicon.ico">
    <link rel="stylesheet" href="/mpx-test-utils/vueschool.css">
    <meta name="description" content="">
    
    <link rel="preload" href="/mpx-test-utils/assets/css/0.styles.752fa634.css" as="style"><link rel="preload" href="/mpx-test-utils/assets/js/app.fb148cee.js" as="script"><link rel="preload" href="/mpx-test-utils/assets/js/3.f258beba.js" as="script"><link rel="preload" href="/mpx-test-utils/assets/js/2.84c2eb9b.js" as="script"><link rel="preload" href="/mpx-test-utils/assets/js/50.71d13616.js" as="script"><link rel="prefetch" href="/mpx-test-utils/assets/js/10.53347021.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/11.747de257.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/12.2d146d94.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/13.f79896ac.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/14.54efafed.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/15.66442892.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/16.31fc9a28.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/17.72d5774f.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/18.9452bbec.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/19.93d90ba0.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/20.d2202369.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/21.d97acaca.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/22.7a4987f5.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/23.4b8e44d2.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/24.9db74204.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/25.79f77496.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/26.bc8732b0.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/27.7c28f474.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/28.77f2e678.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/29.da3b38ec.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/30.4df07c57.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/31.14062c4f.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/32.a313a40e.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/33.99a09109.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/34.06f0a20c.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/35.8c19f14f.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/36.d436326b.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/37.2b59f92a.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/38.96022f76.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/39.4c8bb7dc.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/4.a09a76d7.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/40.c319650f.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/41.5fca3e73.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/42.64099a6b.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/43.20f4acb2.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/44.ffc33cf5.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/45.2098102a.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/46.fea7403c.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/47.b2d03dd7.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/48.c18accb5.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/49.c89be7d5.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/5.277195b4.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/51.5b1f8927.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/52.6e3893b1.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/6.556498fd.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/7.963bf572.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/8.0da16878.js"><link rel="prefetch" href="/mpx-test-utils/assets/js/9.959be6c1.js">
    <link rel="stylesheet" href="/mpx-test-utils/assets/css/0.styles.752fa634.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mpx-test-utils/" class="home-link router-link-active"><!----> <span class="site-name">Mpx框架单元测试</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/mpx-ecology/mpx-test-utils" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/mpx-ecology/mpx-test-utils" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>快速开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mpx-test-utils/installation/introduction-to-basic-tools.html" class="sidebar-link">基础工具简介</a></li><li><a href="/mpx-test-utils/installation/installation-and-configuration.html" class="sidebar-link">安装与配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>教程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mpx-test-utils/guides/getting-started.html" class="sidebar-link">起步</a></li><li><a href="/mpx-test-utils/guides/component-analyze.html" class="sidebar-link">常见技巧</a></li><li><a href="/mpx-test-utils/guides/testing-async-components.html" class="sidebar-link">测试异步行为</a></li><li><a href="/mpx-test-utils/guides/useful-libraries-for-testing.html" class="sidebar-link">实用的测试库</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mpx-test-utils/api/createCompAndAttach.html" class="sidebar-link">createCompAndAttach()</a></li><li><a href="/mpx-test-utils/api/createComp.html" class="sidebar-link">createComp()</a></li><li><a href="/mpx-test-utils/api/mockComponents.html" class="sidebar-link">mockComponents()</a></li><li><a href="/mpx-test-utils/api/proxyFetch.html" class="sidebar-link">proxyFetch()</a></li></ul></section></li><li><a href="/mpx-test-utils/api/rootComponent/" class="sidebar-link">RootComponent</a></li></ul> </aside> <main class="page"><div class="warning-wrapper"></div> <div class="theme-default-content content__default"><h1 id="快速开始"><a href="#快速开始" class="header-anchor">#</a> 快速开始</h1> <h1 id="基础工具简介"><a href="#基础工具简介" class="header-anchor">#</a> 基础工具简介</h1> <h2 id="小程序自定义组件测试工具集"><a href="#小程序自定义组件测试工具集" class="header-anchor">#</a> 小程序自定义组件测试工具集</h2> <p>目前因为小程序独特的运行环境，所以对于小程序自定义组件的单元测试一直没有比较优雅的解决方案，我们需要一个工具将原本小程序自定义组件双线程分离运行的机制调整成单线程模拟运行，利用 dom 环境进行渲染，借此来完成整个自定义组件树的搭建，这里微信官方提供了miniprogram-simulate工具。</p> <h2 id="选择一个测试运行器"><a href="#选择一个测试运行器" class="header-anchor">#</a> 选择一个测试运行器</h2> <p>测试运行器 (test runner) 就是运行测试的程序。</p> <p>主流的 JavaScript 测试运行器有很多，在众多前端单元测试框架中，Jest 目前凭借零配置，高性能，且对于断言，快照，覆盖率等都有很好的集成，是目前较为流行的一个单测框架，当前推荐选择 Jest 做为单测框架</p> <p>Jest 是一个由 Facebook 开发的测试运行器，致力于提供一个“bettery-included”单元测试解决方案。你可以在其<a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>学习到更多 Jest 的知识。</p> <h2 id="浏览器环境"><a href="#浏览器环境" class="header-anchor">#</a> 浏览器环境</h2> <p>小程序组件在单测场景下渲染依赖浏览器环境。技术上讲你可以将其运行在一个真实的浏览器，但是我们并不推荐，因为在不同的平台上都启动真实的浏览器是很复杂的。我们推荐取而代之的是用 <a href="https://github.com/tmpvar/jsdom" target="_blank" rel="noopener noreferrer">JSDOM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 在 Node 虚拟浏览器环境运行测试。</p> <p>Jest 测试运行器自动设置了 JSDOM。对于其它测试运行器来说，你可以在你的测试入口处使用 <a href="https://github.com/rstacruz/jsdom-global" target="_blank" rel="noopener noreferrer">jsdom-global<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 手动设置 JSDOM。</p> <h2 id="测试单文件组件"><a href="#测试单文件组件" class="header-anchor">#</a> 测试单文件组件</h2> <p>Mpx 的单文件组件在它们运行于浏览器之前是需要预编译的。我们目前通过一个 Jest 预编译器来完成此步骤。</p> <p><code>mpx-jest</code> 预处理器支持基本的单文件组件功能，但是目前还不能处理样式块。</p> <p>对于不同的设置方式请移步下面的教程：</p> <ul><li><a href="/mpx-test-utils/installation/installation-and-configuration.html">安装与配置</a></li></ul> <h1 id="安装与配置"><a href="#安装与配置" class="header-anchor">#</a> 安装与配置</h1> <blockquote><p>我们在 <a href="https://github.com/Blackgan3/mpx-unit-test-demo" target="_blank" rel="noopener noreferrer">GitHub<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 上放有一个关于这些设置的示例工程。</p></blockquote> <p>我们将在本章节中对单元测试所需安装的工具库以及相关场景的配置进行介绍</p> <h2 id="安装-miniprogram-simulate"><a href="#安装-miniprogram-simulate" class="header-anchor">#</a> 安装 miniprogram-simulate</h2> <p>miniprogram-simulate 将小程序自定义组件双线程分离运行的机制调整成单线程模拟运行，利用 dom 环境进行渲染，借此来完成整个自定义组件树的搭建，因此需要首先安装该工具集</p> <p>在此工具集的基础之上，我们新增了对Mpx文件的支持以及组件mock等功能，封装产出了一个定制化的工具集 @mpxjs/miniprogram-simulate</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @mpxjs/miniprogram-simulate
</code></pre></div><h2 id="安装-jest"><a href="#安装-jest" class="header-anchor">#</a> 安装 Jest</h2> <p>整个单元测试运行在 Jest 提供的运行环境中，所以我们首先要安装 Jest</p> <p>我们假定你在一开始已经安装并配置好了 webpack 和 Babel——例如通过 <code>@mpxjs/cli</code> 创建了 <code>mpx-demo</code> 模板脚手架。</p> <p>我们要做的第一件事就是安装 Jest 和 Mpx Test Utils：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev jest @mpxjs/test-utils
</code></pre></div><p>然后我们需要在 <code>package.json</code> 中定义一个单元测试的脚本。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="配置转换器"><a href="#配置转换器" class="header-anchor">#</a> 配置转换器</h2> <p>为了告诉 Jest 如何处理 <code>*.mpx</code> 文件，我们需要安装和配置 <code>mpx-jest</code> 预处理器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev @mpxjs/mpx-jest
</code></pre></div><p>Jest的配置可以在 package.json 文件中定义或通过 jest.config.js, 与jest.config.ts 文件或通过 --config &lt;path/to/file.js|ts|cjs|mjs|json&gt; 选项。</p> <p>这里我们统一使用 jest.config.js 配置文件来进行Jest相关配置</p> <p>接下来在在项目根目录新建 <code>jest.config.js</code> 配置文件</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token string-property property">&quot;moduleFileExtensions&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 告诉 Jest 处理 `*.mpx` 文件</span>
        <span class="token string">&quot;mpx&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;testEnvironment&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jsdom&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 测试环境使用 jsdom</span>
    <span class="token string-property property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用 `mpx-jest` 处理 `*.mpx` 文件</span>
        <span class="token string-property property">&quot;^.+\\.mpx$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/node_modules/@mpxjs/mpx-jest&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p><strong>注意：</strong><code>mpx-jest</code> 目前并不支持 <code>@mpxjs/webpack-plugin/loader</code> 所有的功能，比如样式加载。额外的，诸如代码分隔等 webpack 特有的功能也是不支持的。如果要使用这些不支持的特性。</p></blockquote> <h2 id="处理-webpack-别名"><a href="#处理-webpack-别名" class="header-anchor">#</a> 处理 webpack 别名</h2> <p>如果你在 webpack 中配置了别名解析，比如把 <code>@</code> 设置为 <code>/src</code> 的别名，那么你也需要用 <code>moduleNameMapper</code> 选项为 Jest 增加一个匹配配置：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token string-property property">&quot;moduleNameMapper&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;@&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/src&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="为-jest-配置-babel"><a href="#为-jest-配置-babel" class="header-anchor">#</a> 为 Jest 配置 Babel</h2> <p>尽管最新版本的 Node 已经支持绝大多数的 ES2015 特性，你可能仍然想要在你的测试中使用 ES modules 语法和 stage-x 的特性。为此我们需要安装 <code>babel-jest</code>：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> --save-dev babel-jest
</code></pre></div><p>接下来，我们需要在 <code>jest.config.js</code> 的 <code>transform</code> 里添加一个入口，来告诉 Jest 用 <code>babel-jest</code> 处理 JavaScript 测试文件：</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// ...</span>
    <span class="token string-property property">&quot;transform&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 用 `babel-jest` 处理 js</span>
        <span class="token string-property property">&quot;^.+\\.js$&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&lt;rootDir&gt;/node_modules/babel-jest&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>默认情况下，<code>babel-jest</code> 会在其安装完毕后自动进行配置。尽管如此，因为我们已经显性的添加了对 <code>*.mpx</code> 文件的转换，所以现在我们也需要显性的配置 <code>babel-jest</code>。</p></blockquote> <p>我们假设 webpack 使用了 <code>babel-preset-env</code>，这时默认的 Babel 配置会关闭 ES modules 的转译，因为 webpack 已经可以处理 ES modules
了。然而，我们还是需要为我们的测试而开启它，因为 Jest 的测试用例会直接运行在 Node 上。</p> <p>同样的，我们可以告诉 <code>babel-preset-env</code> 面向我们使用的 Node 版本。这样做会跳过转译不必要的特性使得测试启动更快。</p> <p>为了仅在测试时应用这些选项，可以把它们放到一个独立的 <code>env.test</code> 配置项中 (这会被 <code>babel-jest</code> 自动获取)。</p> <p><code>.babelrc</code> 文件示例：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;modules&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;env&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span>
          <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">&quot;node&quot;</span><span class="token operator">:</span> <span class="token string">&quot;current&quot;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然对于 babel 配置文件中的 env.test 部分，你也可以进行其他 plugin 的自定义配置，这是完全由你可控的</p> <h2 id="放置测试文件"><a href="#放置测试文件" class="header-anchor">#</a> 放置测试文件</h2> <p>默认情况下，Jest 将会递归的找到整个工程里所有 <code>.spec.js</code> 或 <code>.test.js</code> 扩展名的文件。如果这不符合你的需求，你也可以在 <code>jest.config.js</code>
里配置来进行改变<a href="https://jestjs.io/docs-Hans/configuration#testregex-string-array-string" target="_blank" rel="noopener noreferrer">改变它的 <code>testRegex</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>Jest 推荐你在被测试代码的所在目录下创建一个 <code>__tests__</code> 目录，但你也可以为你的测试文件随意设计自己习惯的文件结构。不过要当心 Jest 会为快照测试在临近测试文件的地方创建一个 <code>__snapshots__</code> 目录。</p> <h2 id="测试覆盖率"><a href="#测试覆盖率" class="header-anchor">#</a> 测试覆盖率</h2> <p>Jest 可以被用来生成多种格式的测试覆盖率报告。以下是一个简单的起步的例子：</p> <p>扩展你的 <code>jest</code> 配置 (通常在 <code>package.json</code> 或 <code>jest.config.js</code> 中)
的 <a href="https://jestjs.io/docs-Hans/configuration#collectcoverage-boolean" target="_blank" rel="noopener noreferrer"><code>collectCoverage</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
选项，然后添加 <a href="https://jestjs.io/docs-Hans/configuration#collectcoveragefrom-array" target="_blank" rel="noopener noreferrer"><code>collectCoverageFrom</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>数组来定义需要收集测试覆盖率信息的文件。</p> <div class="language-js extra-class"><pre class="language-js"><code>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token string-property property">&quot;collectCoverage&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;collectCoverageFrom&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;**/*.{js,mpx}&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;!**/node_modules/**&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这样就会开启<a href="https://jestjs.io/docs-Hans/configuration#coveragereporters-array-string" target="_blank" rel="noopener noreferrer">默认格式的测试覆盖率报告<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。你可以通过 <code>coverageReporters</code>
选项来定制它们。</p> <div class="language-js extra-class"><pre class="language-js"><code>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token string-property property">&quot;coverageReporters&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;text-summary&quot;</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

</code></pre></div><p>更多文档内容请移步至 <a href="https://jestjs.io/docs-Hans/configuration#collectcoverage-boolean" target="_blank" rel="noopener noreferrer">Jest 配置文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在那里你可以找到覆盖率阀值、目标输出目录等选项。</p> <h2 id="定制-resolver"><a href="#定制-resolver" class="header-anchor">#</a> 定制 resolver</h2> <p>Mpx 框架本身支持文件纬度的跨平台构建以及页面组件路径索引功能，这部分能力是在webpack构建时通过 enhanced-resolve 插件来实现，当我们单测运行的组件中存在以下代码时</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 构建时动态获取页面路径</span>
<span class="token keyword">import</span> somePage <span class="token keyword">from</span> <span class="token string">'../sub1/pages/index.mpx?resolve'</span>

<span class="token comment">// 或者存在跨平台文件后缀声明时</span>
<span class="token comment">/**
 * /componentList
 *   index.wx.mpx
 *   index.ali.mpx
 */</span>
<span class="token keyword">import</span> componentList <span class="token keyword">from</span> <span class="token string">'../componentList/index.mpx'</span>

<span class="token comment">// 或者是异步分包场景我们对组件的引用</span>
<span class="token punctuation">{</span>
    <span class="token literal-property property">componentA</span><span class="token operator">:</span> <span class="token string">'../someComp/list.mpx?root=sub1'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上两种场景的代码在单测运行时都会导致报错，报错的原因时 Jest 运行时找不到对应的文件</p> <p>这种情况我们就需要使用 Jest 提供的 <a href="https://jestjs.io/zh-Hans/docs/configuration#resolver-string" target="_blank" rel="noopener noreferrer">resolver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 能力来解决</p> <p>配置了 resolver 之后, Jest 运行时对文件的加载会先经过 resolver 处理</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token literal-property property">resolver</span><span class="token operator">:</span> <span class="token string">'./mpx-custom-resolver.js'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后对应的 mpx-custom-resolver.js 的内容</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reqPath<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理路径构建时索引问题</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reqPath<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?resolve'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./test/customResolverDefault.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> realPath <span class="token operator">=</span> reqPath
  <span class="token comment">// 处理组件异步分包引用方式</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reqPath<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'?root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    realPath <span class="token operator">=</span> reqPath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?root'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> options<span class="token punctuation">.</span><span class="token function">defaultResolver</span><span class="token punctuation">(</span>realPath<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>options
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>至此，在完成了上述一整套的依赖安装和相关配置之后，这时候你就可以开始着手进行组件单元测试的书写了，我们将在下一章中进行单元测试书写时的设计以及相关问题解决讲解</p> <h2 id="相关资料"><a href="#相关资料" class="header-anchor">#</a> 相关资料</h2> <ul><li><a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">Jest<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/babel/babel-preset-env" target="_blank" rel="noopener noreferrer">Babel preset env<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/mpx-ecology/mpx-test-utils/edit/dev/docs/installation/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/mpx-test-utils/assets/js/app.fb148cee.js" defer></script><script src="/mpx-test-utils/assets/js/3.f258beba.js" defer></script><script src="/mpx-test-utils/assets/js/2.84c2eb9b.js" defer></script><script src="/mpx-test-utils/assets/js/50.71d13616.js" defer></script>
  </body>
</html>
